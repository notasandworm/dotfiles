#!/bin/bash

# -----------------------------------------------------------------------------
# Configuration & Defaults
# -----------------------------------------------------------------------------
TARGET_DIR="."
DELETE_ORIGINALS=true
QUALITY=75     # Slightly reduced from 80 for better web optimization
MAX_WIDTH=1920 # Default constraint for web viewing
RESIZE=true    # Default behavior is to resize

# -----------------------------------------------------------------------------
# Usage Function
# -----------------------------------------------------------------------------
usage() {
  echo "Usage: $0 [-d directory] [-k] [-s] [-w width]"
  echo "  -d  Specify target directory (default: current directory)"
  echo "  -k  Keep original files (default: delete originals after successful conversion)"
  echo "  -s  Skip resizing (keep original dimensions)"
  echo "  -w  Set specific max width (default: 1920)"
  exit 1
}

# -----------------------------------------------------------------------------
# Argument Parsing
# -----------------------------------------------------------------------------
while getopts "d:ksw:" opt; do
  case $opt in
  d) TARGET_DIR="$OPTARG" ;;
  k) DELETE_ORIGINALS=false ;;
  s) RESIZE=false ;;        # New flag to opt-out of resizing
  w) MAX_WIDTH="$OPTARG" ;; # Allow custom width override
  *) usage ;;
  esac
done

# -----------------------------------------------------------------------------
# Validation
# -----------------------------------------------------------------------------
if [[ ! -d "$TARGET_DIR" ]]; then
  echo "Error: Directory '$TARGET_DIR' does not exist."
  exit 1
fi

if ! command -v cwebp &>/dev/null; then
  echo "Error: cwebp is not installed. Please install 'libwebp'."
  exit 1
fi

# -----------------------------------------------------------------------------
# Execution
# -----------------------------------------------------------------------------
echo "Processing directory: $TARGET_DIR"
echo "Settings: Quality=$QUALITY | Resize=$RESIZE | Max Width=$MAX_WIDTH"

find "$TARGET_DIR" -type f \
  \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) \
  -print0 |
  while IFS= read -r -d '' file; do

    # Logic to handle self-conversion (webp -> webp)
    filename=$(basename -- "$file")
    extension="${filename##*.}"
    filename_no_ext="${file%.*}"

    # If input is already webp, write to a temp file first to avoid corruption
    if [[ "${extension,,}" == "webp" ]]; then
      output_name="${filename_no_ext}_optimized.webp"
      is_reencode=true
    else
      output_name="${filename_no_ext}.webp"
      is_reencode=false
    fi

    # Construct Command
    cmd="cwebp -q $QUALITY"

    if [ "$RESIZE" = true ]; then
      # 0 as the second parameter maintains aspect ratio
      cmd+=" -resize $MAX_WIDTH 0"
    fi

    # Execute conversion
    # and minimize output clutter
    $cmd "$file" -o "$output_name" -quiet

    conversion_status=$?

    if [ $conversion_status -eq 0 ]; then

      # Handling overwrite for WebP re-encoding
      if [ "$is_reencode" = true ]; then
        mv "$output_name" "$file"
        echo "[OK] Re-optimized: $file"
        # No deletion logic needed here as overwritting the file
      else
        echo "[OK] Converted: $file"
        # Only delete if configured AND conversion succeeded
        if [ "$DELETE_ORIGINALS" = true ]; then
          rm "$file"
          echo "     Deleted original: $file"
        fi
      fi
    else
      echo "[ERROR] Failed to convert: $file"
      # Clean up temp file if it exists
      [[ -f "$output_name" ]] && rm "$output_name"
    fi

  done
